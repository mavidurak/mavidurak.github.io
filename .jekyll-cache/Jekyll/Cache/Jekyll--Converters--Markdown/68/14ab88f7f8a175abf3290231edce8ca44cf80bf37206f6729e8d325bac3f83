I"<p>Passport.js Node JS iÃ§in geliÅŸtirilmiÅŸ authentication(yetkilendirme) modÃ¼lÃ¼dÃ¼r, bu modÃ¼lÃ¼ kullanarak destek veren tÃ¼m sosyal aÄŸ hesaplarÄ±na eriÅŸebilir, web uygulamalarÄ±nÄ±zda oturum denetimini bu sosyal aÄŸlarÄ±n aracÄ±lÄ±ÄŸÄ±yla yÃ¶netebilirsiniz.
  Bu modÃ¼l tek bir iÅŸi yerine getirmek iÃ§in geliÅŸtirilmiÅŸtir, yetkilendirme. YazÄ±da ilerledikÃ§e gÃ¶receksiniz ki iÅŸinde oldukÃ§a iyi ve oldukÃ§a kullanÄ±ÅŸlÄ± Ã¶zelliklere sahip. Destek veren herhangi bir sosyal aÄŸÄ±n API(Application Programming Interface)â€™nÄ± kullanarak ziyaretÃ§ilerin web uygulamanÄ±za giriÅŸ yapmanÄ±zÄ± saÄŸlamanÄ±z Passport.js ile Ã§ok kolaydÄ±r.<!--more--></p>

<p>Modern web uygulamalarÄ±nda yetkilendirme Ã§ok farklÄ± ÅŸekillerde yapÄ±labilir, geleneksel yÃ¶ntemde kullanÄ±cÄ±lar sisteme kullanÄ±cÄ± adÄ± ve parolalarÄ±yla giriÅŸ yaparlar. Ancak sosyal aÄŸlarÄ±n yÃ¼kseliÅŸiyle birlikte artÄ±k yetkilendirme iÅŸlemleri Facebook Twitter gibi popÃ¼ler OAuth saÄŸlayÄ±cÄ±larÄ±nÄ±n single sign-in (tek bir oturum aÃ§ma) trendine doÄŸru kaymaya baÅŸladÄ±. Ã‡oÄŸu zaman bu sosyal aÄŸlarÄ±n altyapÄ±larÄ±nÄ± kullanarak oturum aÃ§abilmek ve kullanÄ±cÄ±larÄ±n bilgilerine eriÅŸebilmek iÃ§in token denilen geÃ§ici anahtarlar kullanÄ±lÄ±r.
  Her web uygulamasÄ±nÄ±n farklÄ± kullanÄ±cÄ± bilgilerine gereksinimi vardÄ±r ancak passportJs tÃ¼m bu gereksinimleri karÅŸÄ±layabilecek ÅŸekilde tasarlanmÄ±ÅŸ oldukÃ§a kullanÄ±ÅŸlÄ± bir modÃ¼l.
  PassportJsâ€™de yetkilendirme mekanizmalarÄ± â€œStrategyâ€ diye tanÄ±mlanÄ±r, her sosyal aÄŸÄ±n mekanizmasÄ± farklÄ±dÄ±r ancak passportJs baÄŸÄ±mlÄ±lÄ±klarÄ± yok ederek modÃ¼ler ÅŸekilde tasarlandÄ±ÄŸÄ±ndan tÃ¼m â€œStrategyâ€ modÃ¼lleri ayrÄ± birer pakettir. Hangi sosyal aÄŸ aracÄ±lÄ±yla bilgilere eriÅŸmek isterseniz uygulamanÄ±za onu eklersiniz olur biter.</p>

<p>Biraz sonra tek tek aÃ§Ä±klamadan Ã¶nce size ne kadar temiz bir kod yazÄ±mÄ± saÄŸladÄ±ÄŸÄ±nÄ± gÃ¶stermek iÃ§in basit bir Ã¶rnek vermek istiyorum</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">local</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">successRedirect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span>
                                                  <span class="na">failureRedirect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span> <span class="p">}));</span></code></pre></figure>

<p>PassportJSâ€™i node package manager Ã¼zerinden tek satÄ±rla yÃ¼kleyebilir, uygulamanÄ±za ekleyebilirsiniz.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>passport</code></pre></figure>

<h3 id="yetkilendirme">Yetkilendirme</h3>

<p>Serverâ€™a gelen bir yetkilendirme yani oturum aÃ§ma isteÄŸini uygun ÅŸekilde karÅŸÄ±lamak <code class="language-plaintext highlighter-rouge">passport.authenticate()</code> yazmak kadar kolaydÄ±r. Methodun iÃ§ine kendiniz iÃ§in uygun olan â€œStrategyâ€ i yazarsÄ±nÄ±z ve sistem tÄ±kÄ±r tÄ±kÄ±r iÅŸler.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"> <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span>
  <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">local</span><span class="dl">'</span><span class="p">),</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// EÄŸer bu fonksiyon devreye girdiyse, yetkilendirme baÅŸarÄ±lÄ± demektir</span>
    <span class="c1">// `req.user` objesi yetkilendirilmiÅŸ kullanÄ±cÄ±nÄ±n bilgilerini iÃ§erir</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span>
  <span class="p">});</span></code></pre></figure>

<p>GÃ¶rÃ¼ldÃ¼ÄŸÃ¼ gibi yukarÄ±daki kodda stratejimizi <code class="language-plaintext highlighter-rouge">local</code> olarak belirledik. YukarÄ±daki senaryo yetkilendirme sÄ±rasÄ±nda bir hata oluÅŸmamasÄ± durumunda olacak gÃ¼llÃ¼k gÃ¼listanlÄ±k durumu gÃ¶steriyor, ancak biliyoruz ki hayat bu kadar kolay deÄŸil. Ä°ÅŸlerin boka sarmasÄ± durumunda yani diÄŸer tabirle yetkilendirme sÄ±rasÄ±nda bir hata oluÅŸtuÄŸunda PassportJS varsayÄ±lan olarak <code class="language-plaintext highlighter-rouge">401 Unauthorized</code> HTTP headerÄ±nÄ± dÃ¶ndÃ¼rÃ¼r. EÄŸer yetkilendirmede sorun Ã§Ä±kmazsa <code class="language-plaintext highlighter-rouge">req.user</code> objesi tanÄ±mlanÄ±r ve iÅŸlemlerimizde kolayca kullanabiliriz, bu kÄ±sÄ±mla ilgili ayrÄ±ntÄ±larÄ± konfigrasyon kÄ±smÄ±nda detaylÄ± ÅŸekilde beraber gÃ¶rÃ¼cez.</p>

<h2 id="yÃ¶nlendirmeler">YÃ¶nlendirmeler</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Her yetkilendirme isteÄŸinden sonra sonuca gÃ¶re uygun bi yÃ¶nlendirme mutlaka yapÄ±lÄ±r, tabi giriÅŸ isteÄŸi yaptÄ±ktan sonra ekrana bakÄ±p bekleyen zombiler yaratmak istemiyorsanÄ±z.
</code></pre></div></div>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">local</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">successRedirect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span>
                                 <span class="na">failureRedirect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span> <span class="p">}));</span></code></pre></figure>

<p>Bu dÃ¼zenlemeyle fonksiyonun varsayÄ±lan davranÄ±ÅŸÄ±nÄ± override ettik, yani ezdik kendi kuralÄ±mÄ±zÄ± belirledik. Herhangi bir problem olmadan yetkilendirme tamamlanÄ±rsa kullanÄ±cÄ±yÄ± anasayfaya yÃ¶nlendiricez, ancak herhangi bi problem oluÅŸur da yetkilendirme baÅŸarÄ±sÄ±z olursa kullanÄ±cÄ± login sayfasÄ±na tekrar geri gelecek.</p>

<h2 id="flash-bildirimler">Flash Bildirimler</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>YÃ¶nlendirmelerle birlikte kullanÄ±cÄ±lar iÃ§in iÅŸleri anlamlÄ± hale getirecek bildirimler de gÃ¶ndermeliyiz, o da ÅŸÃ¶yle.
</code></pre></div></div>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">local</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">successRedirect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span>
                                 <span class="na">failureRedirect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span>
                                 <span class="na">failureFlash</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">);</span></code></pre></figure>

<p>Muhtemelen sizin de dikkat ettiÄŸiniz gibi kodumuza yeni bi parametre daha ekledik <code class="language-plaintext highlighter-rouge">failureFlash:true</code>, bu tanÄ±mlamayla PassportJs yetkilendirme sÄ±rasÄ±nda oluÅŸacak hatayÄ± kullanÄ±cÄ±ya kendiliÄŸinden gÃ¶sterecek.
  Bu Ã§oÄŸu zaman tercih edilen bi kullanÄ±mdÄ±r, Ã§Ã¼nkÃ¼ hata doÄŸrudan passportJsâ€™den geldiÄŸinden oluÅŸan hatanÄ±n iÃ§eriÄŸini kullanÄ±cÄ±nÄ±n da Ã¶ÄŸrenmesini saÄŸlar.</p>

<p>Ancak alternatif bir yol olarak</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">local</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">failureFlash</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Invalid username or password.</span><span class="dl">'</span> <span class="p">});</span></code></pre></figure>

<p>ÅŸeklinde kendimiz de bir flash mesaj tanÄ±mlayabiliriz.</p>

<p>â€œAraman iÃ§in illa hata yapmam mÄ± lazÄ±mâ€ ilkesinde de yola Ã§Ä±karak kullanÄ±cÄ±ya iÅŸlerin sadece kÃ¶tÃ¼ gittiÄŸini deÄŸil sorunsuz tamamlandÄ±ÄŸÄ±nÄ± gÃ¶stermek iÃ§in de flash mesaj yollayabiliriz. ÅÃ¶yle ki:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">local</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">successFlash</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Welcome!</span><span class="dl">'</span> <span class="p">});</span></code></pre></figure>

<p>Burada hatÄ±rlatmam gereken kÃ¼Ã§Ã¼k bi nokta var, flash mesajlarÄ± kullanabilmek iÃ§in <code class="language-plaintext highlighter-rouge">req.flash()</code> methoduna ihtiyaÃ§ var, Express frameworkâ€™Ã¼n 2x versiyonlarÄ± bu methodu destekliyor ancak 3x versiyonlarda kaldÄ±rÄ±ldÄ± o yÃ¼zden ÅŸu modÃ¼lÃ¼ projenize dahil etmeniz lazÄ±m
  https://github.com/jaredhanson/connect-flash</p>

<h2 id="sessionÄ±-devre-dÄ±ÅŸÄ±-bÄ±rakmak">Sessionâ€™Ä± Devre DÄ±ÅŸÄ± BÄ±rakmak</h2>

<p>BaÅŸarÄ±lÄ± bi ÅŸekilde yetkilendirme yapÄ±ldÄ±ktan sonra, sistem kalÄ±cÄ± bir session oluÅŸturacaktÄ±r. Bu ziyaretÃ§ilerin web tarayÄ±cÄ±larÄ±yla kullandÄ±ÄŸÄ± web uygulamarÄ±nda tercih edilen genel bi kullanÄ±mdÄ±r, ancak bazÄ± Ã¶zel durumlarda, session gerekli deÄŸildir.
   Ã–rnek verecek olursak; API sunucularÄ±ndan her istekte kullanÄ±cÄ± kimliÄŸi zaten temin edilir. Bu durumda bizim iÃ§in sessionâ€™Ä± devre dÄ±ÅŸÄ± bÄ±rakmak mantÄ±klÄ± bi seÃ§im olacaktÄ±r. Peki nasÄ±l bÄ±rakÄ±rÄ±z, ÅŸÃ¶yle ki:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/api/users/me</span><span class="dl">'</span><span class="p">,</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">basic</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">session</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}),</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">id</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="na">username</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">username</span> <span class="p">});</span>
<span class="p">});</span></code></pre></figure>

<h2 id="kendi-iÌ‡htiyacÄ±mÄ±za-gÃ¶re-callback-oluÅŸturma">Kendi Ä°htiyacÄ±mÄ±za GÃ¶re Callback OluÅŸturma</h2>

<p>YukarÄ±daki tÃ¼m senaryolar failure ya da success durumlarÄ±nda uygulamanÄ±n nasÄ±l davranacaÄŸÄ±nÄ± verdiÄŸimiz parametrelerle yÃ¶netiyordu, ancak bazen kurallarÄ± bizim koymamÄ±z gerekir. Bizim geliÅŸtirdiÄŸimiz uygulamada bizim sÃ¶zÃ¼mÃ¼z geÃ§er hafÄ±z.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">local</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">);</span> <span class="p">}</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">logIn</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">/users/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">})(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>

<p>YukarÄ±daki kodda <code class="language-plaintext highlighter-rouge">authenticate()</code> methodunun routerâ€™Ä±n altÄ±nda olduÄŸuna dikkat edin, bu ÅŸekilde kullanÄ±mamÄ±zÄ±n nedeni <code class="language-plaintext highlighter-rouge">authenticate()</code> methodunun iÃ§inde <code class="language-plaintext highlighter-rouge">req</code> ve <code class="language-plaintext highlighter-rouge">res</code> nesnelerine eriÅŸmek istememiz.
  Yetkilendirme iÅŸlemi sÄ±rasÄ±nda bir hata oluÅŸtuÄŸunda <code class="language-plaintext highlighter-rouge">user</code> nesnesi <code class="language-plaintext highlighter-rouge">false</code> â€˜a eÅŸit olur. Bir hata oluÅŸtuÄŸunda <code class="language-plaintext highlighter-rouge">err</code> nesnesi aracÄ±lÄ±ÄŸÄ±yla otomatik olarak hata fÄ±rlatÄ±lÄ±r, aksi durumlarda <code class="language-plaintext highlighter-rouge">null</code> a eÅŸittir.</p>

<h3 id="konfigrasyon">Konfigrasyon</h3>

<p>PassportJSâ€™de yetkilendirme iÃ§in Ã¼Ã§ konfigrasyona ihtiyaÃ§ duyarÄ±z</p>

<p>1- Yetkilendirme Stratejileri
  2- Uygulama KatmanlarÄ±
  3- Sesssionlar (Bu tercihe baÄŸlÄ±)</p>

<h2 id="stratejiler-strategies">Stratejiler (Strategies)</h2>

<p>PassportJs baÄŸlantÄ±larÄ± yetkilendirirken <code class="language-plaintext highlighter-rouge">Strategy</code> denilen kurallarÄ± kullanÄ±r. KullanÄ±cÄ± adÄ± ve parolayÄ± <code class="language-plaintext highlighter-rouge">OAuth</code> ya da <code class="language-plaintext highlighter-rouge">OpenID</code> aracÄ±lÄ±ÄŸÄ±yla doÄŸrular ve oturumu yÃ¶netir.
  Passportâ€™a bir doÄŸrulama-yetkilendirme isteÄŸi yollamadan Ã¶nce <code class="language-plaintext highlighter-rouge">Strategy</code> denilen kurallar mutlaka tanÄ±mlanmalÄ±dÄ±r.
  Stratejiler ve onlarÄ±n konfigrasyonlarÄ± <code class="language-plaintext highlighter-rouge">use()</code> fonksiyonunu destekler, KullanÄ±cÄ± adÄ± ve ÅŸifreyle yapÄ±lan bir lokal doÄŸrulama iÃ§in ÅŸu koda bi gÃ¶z atalÄ±m;</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">passport</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">,</span> <span class="nx">LocalStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">passport-local</span><span class="dl">'</span><span class="p">).</span><span class="nx">Strategy</span><span class="p">;</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">LocalStrategy</span><span class="p">(</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">username</span> <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Incorrect username.</span><span class="dl">'</span> <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">validPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Incorrect password.</span><span class="dl">'</span> <span class="p">});</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">));</span></code></pre></figure>

<h2 id="doÄŸrulama-yanÄ±tlarÄ±-verify-callbacks">DoÄŸrulama YanÄ±tlarÄ± (Verify Callbacks)</h2>

<p>Her ne kadar TÃ¼rkÃ§e kaynak oluÅŸsun diye uÄŸraÅŸÄ±yor olsak da bazÄ± terimlerin ingilizcelerini duymanÄ±z sizin iÃ§in daha yararlÄ± olcaktÄ±r, aksi halde bildiÄŸiniz terimleri duyduÄŸunuz dahi ingilizcesini bilmediÄŸinizden olaya fransÄ±z kalmanÄ±z kaÃ§Ä±nÄ±lmaz olacaktÄ±r, bu yÃ¼zden elimden geldiÄŸince TÃ¼rkÃ§eâ€™ye Ã§evirmeye Ã§alÄ±ÅŸsam da Ã¶zgÃ¼n tabirleri ingilizce olarak da yazÄ±yorum.</p>

<p>YukarÄ±daki Ã¶rnek kodumuz Ã¶nemli bi konsepti iÃ§eriyor, Stratejilerde durumlara gÃ¶re geri dÃ¶nÃ¼ÅŸleri tanÄ±mlamamÄ±z gerekir. Flash Bildirimleri baÅŸlÄ±ÄŸÄ±nÄ± hatÄ±rlayÄ±n, doÄŸrulamanÄ±n amacÄ± gÃ¶nderilen kimlik bilgilerine sahip kullanÄ±cÄ± bulup yetkilendirmeyi yapmaktÄ±r.</p>

<p>Kimlik bilgileri geÃ§erliyse ve Passport tarafÄ±ndan onaylandÄ±ysa (ki belirlediÄŸimiz stratejiye uygunsa passport tarafÄ±ndan valid olarak tanÄ±mlanacak yani onaylanacaktÄ±r) passportJS kullanÄ±cÄ±yÄ± doÄŸruladÄ±ÄŸÄ±nÄ± belirtmek iÃ§in <code class="language-plaintext highlighter-rouge">done</code> methodunu Ã§aÄŸÄ±racaktÄ±r.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript">  <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span></code></pre></figure>

<p>EÄŸer bilgiler geÃ§erli deÄŸilse mesela parola yanlÄ±ÅŸsa <code class="language-plaintext highlighter-rouge">done</code> methodu <code class="language-plaintext highlighter-rouge">false</code> parametresiyle Ã§aÄŸrÄ±lacaktÄ±r.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span></code></pre></figure>

<p>Bu gibi durumlarda opsiyonel mesajlar da eklenerek flash bildirimler gÃ¶sterilebilir ve kullanÄ±cÄ±lar yeniden denemeye yÃ¶nlendirilir</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Incorrect password.</span><span class="dl">'</span> <span class="p">});</span></code></pre></figure>

<p>Son olarak eÄŸer daha derin bi hata varsa mesela database baÄŸlantÄ±sÄ± yoksa iÅŸid Sakaryaâ€™ya geldiyse ya da bulunduÄŸunuz konuma yaklaÅŸan devasa bi meteor varsa falan bilindik node tarzÄ± <code class="language-plaintext highlighter-rouge">err</code> fÄ±rlatÄ±lÄ±r siz de bunu yakalayÄ±p dÃ¶ndÃ¼rÃ¼rsÃ¼nÃ¼z.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span></code></pre></figure>

<h2 id="katmanlar">Katmanlar</h2>

<p>Express framework ile web uygulamalarÄ± geliÅŸtirirken ki Ã§oÄŸu zaman uygulamalarÄ±mÄ±zÄ± bu Ã§atÄ± altÄ±nda geliÅŸtiririz, passportJsâ€™in ihtiyaÃ§ duyduÄŸu bazÄ± konfigrasyonlar vardÄ±r, <code class="language-plaintext highlighter-rouge">passport.initialize()</code> belirtimi yapÄ±lmalÄ±dÄ±r, eÄŸer uygulamanÄ±zda session kullanÄ±yosanÄ±z bunun yanÄ±nda <code class="language-plaintext highlighter-rouge">passport.session()</code> da deklare edilmek zorundadÄ±r.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kd">static</span><span class="p">(</span><span class="dl">'</span><span class="s1">public</span><span class="dl">'</span><span class="p">));</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">cookieParser</span><span class="p">());</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">());</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">session</span><span class="p">({</span> <span class="na">secret</span><span class="p">:</span> <span class="dl">'</span><span class="s1">keyboard cat</span><span class="dl">'</span> <span class="p">}));</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">initialize</span><span class="p">());</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">passport</span><span class="p">.</span><span class="nx">session</span><span class="p">());</span>
  <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">router</span><span class="p">);</span>
<span class="p">});</span></code></pre></figure>

<h3 id="kullanÄ±cÄ±-adÄ±--parola-aracÄ±lÄ±ÄŸÄ±yla-giriÅŸ">KullanÄ±cÄ± AdÄ± &amp; Parola AracÄ±lÄ±ÄŸÄ±yla GiriÅŸ</h3>

<p>En Ã§ok tercih edilen yÃ¶ntemle beraber bir Ã¶rnek yapÄ±p yazÄ±mÄ± sonlandÄ±rmak istiyorum</p>

<p>Bu uygulama iÃ§in <code class="language-plaintext highlighter-rouge">passport-local</code> modÃ¼lÃ¼ne ihtiyacÄ±mÄ±z var, npm denilen canÄ±mÄ±z ciÄŸerimiz paket yÃ¶neticisi aracÄ±lÄ±ÄŸÄ±yla tabi ki Ã§ok kolay.</p>

<h2 id="yÃ¼kleme">YÃ¼kleme</h2>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>npm <span class="nb">install </span>passport-local</code></pre></figure>

<h2 id="konfigrasyon-1">Konfigrasyon</h2>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">passport</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">passport</span><span class="dl">'</span><span class="p">)</span>
<span class="p">,</span> <span class="nx">LocalStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">passport-local</span><span class="dl">'</span><span class="p">).</span><span class="nx">Strategy</span><span class="p">;</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">LocalStrategy</span><span class="p">(</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">username</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Incorrect username.</span><span class="dl">'</span> <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">.</span><span class="nx">validPassword</span><span class="p">(</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Incorrect password.</span><span class="dl">'</span> <span class="p">});</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
<span class="p">});</span>
<span class="p">}</span>
<span class="p">));</span></code></pre></figure>

<p>Local yetkilendirme iÃ§in formumuzdan gelecek username ve password verilerine uygun olarak callbacklerimizi tanÄ±mladÄ±k.</p>

<h2 id="form">Form</h2>

<p>Åimdi formu oluÅŸturalÄ±m</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/login"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
<span class="nt">&lt;div&gt;</span>
  <span class="nt">&lt;label&gt;</span>Username:<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div&gt;</span>
  <span class="nt">&lt;label&gt;</span>Password:<span class="nt">&lt;/label&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Log In"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span></code></pre></figure>

<h2 id="yÃ¶nlendirme-routing">YÃ¶nlendirme (Routing)</h2>

<p>formdan gelen post isteÄŸini yakalayÄ±p passport ile konuÅŸturmak iÃ§in gerekli kodlarÄ±mÄ±zÄ± yazÄ±yoruz</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span>
<span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="dl">'</span><span class="s1">local</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">successRedirect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span>
                             <span class="na">failureRedirect</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/login</span><span class="dl">'</span><span class="p">,</span>
                             <span class="na">failureFlash</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span>
<span class="p">);</span></code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">failureFlash</code> parametresinin true olmasÄ±na dikkat etmiÅŸsinizdir, kullanÄ±cÄ±lar iÃ§in Flash Bildirimler gÃ¶nderiyoruz.</p>

<h2 id="parametreler">Parametreler</h2>

<p>VarsayÄ±lan olarak <code class="language-plaintext highlighter-rouge">LocalStrategy</code> de formdan gelen kullanÄ±cÄ± adÄ± <code class="language-plaintext highlighter-rouge">username</code> ve <code class="language-plaintext highlighter-rouge">password</code> olarak tanÄ±mlÄ±dÄ±r, ben deÄŸiÅŸiklik yapmak istiyorum dersen ÅŸu ÅŸekilde yapabilirsin diyerek bu gereksiz bilgiyle yazÄ±ma son veriyorum.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">LocalStrategy</span><span class="p">({</span>
<span class="na">usernameField</span><span class="p">:</span> <span class="dl">'</span><span class="s1">email</span><span class="dl">'</span><span class="p">,</span>
<span class="na">passwordField</span><span class="p">:</span> <span class="dl">'</span><span class="s1">passwd</span><span class="dl">'</span>
<span class="p">},</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// ...</span>
<span class="p">}</span>
<span class="p">));</span></code></pre></figure>

<p>OldukÃ§a kullanÄ±ÅŸlÄ± bi modÃ¼l olan PassportJSâ€™i her geliÅŸtiriciye tavsiye ederim, eski projelerimde kullanmamÄ±ÅŸ olsam da bundan sonraki her projemde kesinlikle tercih edeceÄŸim bir modÃ¼l.
OkuduysanÄ±z yazÄ±nÄ±n linkini paylaÅŸmanÄ±z teÅŸekkÃ¼r yerine geÃ§ecektir. AyrÄ±ca sizler de blogda kendi yazÄ±larÄ±nÄ±zÄ± yayÄ±nlayabilirsiniz. Åimdiden teÅŸekkÃ¼rler.</p>

<p>Furkan BAÅARAN <a href="mailto:frknbasaran@gmail.com">frknbasaran@gmail.com</a>
@frknbasaran</p>
:ET